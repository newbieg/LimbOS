## I started to wrap all included kernel files in if statements.
## if the object files existed, I did not wnt to rebuild them from source, just
## use what is there.
## I feel this is a bad idea because it means that I'll likely forget that
## I made this modification, and won't understand why changes to the system
## aren't taking affect. 
## benefits: Slightly faster build time.
##	More dificulty in adding a file so fewer files likely to be added.
## disadvantages: likely to cause build issues
## 		convolution
##		Takes longer to add files.
CFLAGS=-ffreestanding -O2 -std=gnu99 -Wall -Wextra -Iinclude
CFILEFLAGS=-c
CLINKERFLAGS=-ffreestanding -O2 -nostdlib
STABLE_FOLDER = stable_src

CC=i686-elf-gcc
AS=i686-elf-as

all: build iso run clean

build:
	if [ ! -a "boot.o" ]; then $(AS) src/boot.s -o boot.o; fi;
	if [ ! -a "string.o" ]; then $(CC) $(CFILEFLAGS) src/string.c -o string.o $(CFLAGS); fi;
	if [ ! -a "math.o" ]; then $(CC) $(CFILEFLAGS) src/math.c -o math.o $(CFLAGS); fi;
	if [ ! -a "tty.o" ]; then $(CC) $(CFILEFLAGS) src/tty.c -o tty.o $(CFLAGS); fi;
	$(CC) $(CFILEFLAGS) src/kernel.c -o kernel.o $(CFLAGS)
	$(CC) -T linker.ld -o myos.bin $(CLINKERFLAGS) boot.o string.o math.o tty.o kernel.o -lgcc

build_stable:
	$(AS) $(STABLE_FOLDER)/boot.s -o boot.o
	$(CC) $(CFILEFLAGS) $(STABLE_FOLDER)/string.c -o string.o $(CFLAGS)
	$(CC) $(CFILEFLAGS) $(STABLE_FOLDER)/math.c -o math.o $(CFLAGS)
	$(CC) $(CFILEFLAGS) $(STABLE_FOLDER)/tty.c -o tty.o $(CFLAGS)
	$(CC) $(CFILEFLAGS) $(STABLE_FOLDER)/kernel.c -o kernel.o $(CFLAGS)
	$(CC) -T linker.ld -o myos.bin $(CLINKERFLAGS) boot.o string.o math.o tty.o kernel.o -lgcc

stable: build_stable
	cp myos.bin isodir/boot/myos_stable.bin
	cp grub.cfg isodir/boot/grub/

iso:
	cp myos.bin isodir/boot/myos_nightly.bin
	cp grub.cfg isodir/boot/grub/
	grub2-mkrescue -o myos.iso isodir

run:
	qemu-system-i386 -cdrom myos.iso

clean:
	-rm *.o *.h.gch

nasm:
	nasm -f elf32 smallest.s
	ld -T link.ld -melf_i386 smallest.o -o myos.bin
	cp myos.bin isodir/boot/
	grub2-mkrescue -o myos.iso isodir
	bochs -f bock.txt -q
	



